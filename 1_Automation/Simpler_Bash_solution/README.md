
# AWS EC2 Instances Grouped by AMI: Bash Script

## Overview

This project contains a Bash script designed to retrieve information about all EC2 instances in an AWS account, grouped by the Amazon Machine Image (AMI) IDs they are using. It also collects detailed information about the AMIs and organizes the data into a JSON structure for clarity and ease of use.

This script is efficient, concise, and secure, making it a practical tool for AWS administrators, DevOps professionals, and engineers who need to audit or manage EC2 resources effectively.

---

## Key Features

### **Core Functionality**
- **Instance Grouping by AMI**: Collects all EC2 instances and groups them by the AMI IDs they use.  
- **AMI Information**: Retrieves details such as:
  - **Image Description**: A brief description of the AMI.
  - **Image Name**: The name assigned to the AMI.
  - **Image Location**: The storage location of the AMI.
  - **Owner ID**: The account ID of the AMI owner.

### **Error Handling**
- Handles deregistered or missing AMIs gracefully, returning `null` for unavailable fields.

### **Output**
- The results are output as a JSON file named `ami_output.json`, making it easy to parse and use in other tools or reports.

### **Security**
- The script ensures minimal exposure of AWS data by making specific API calls to retrieve only necessary information.
- Uses AWS CLI profiles for secure credential management.

---

## Prerequisites

To run the script, you need the following:

1. **AWS CLI**: Installed and configured on your system with valid credentials. You can set up the CLI by following [AWS CLI Configuration Guide](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html).  
2. **jq**: A lightweight JSON parser used for handling and formatting JSON data in the script. Install it using your package manager:
   ```bash
   sudo apt install jq # Ubuntu/Debian
   sudo yum install jq # CentOS/RHEL
   brew install jq     # macOS
   ```
3. **Permissions**: The script requires the following AWS permissions:
   - `ec2:DescribeInstances`
   - `ec2:DescribeImages`

---

## How It Works

### **Script Breakdown**
1. **Retrieve EC2 Instances**  
   The script uses the AWS CLI to get details of all EC2 instances in the current region:
   ```bash
   aws ec2 describe-instances
   ```
   It extracts relevant data such as the instance IDs and AMI IDs using `jq`.

2. **Group Instances by AMI**  
   Each instance is grouped under its corresponding AMI ID, forming a structure that shows which instances are using which AMIs.

3. **Fetch AMI Details**  
   For each unique AMI ID, the script retrieves details like the description, name, location, and owner using:
   ```bash
   aws ec2 describe-images --image-ids
   ```

4. **Handle Missing AMIs**  
   If an AMI is deregistered or missing, the script gracefully handles the error and assigns `null` values to the unavailable fields.

5. **Output Results**  
   The grouped data is saved as a JSON file (`ami_output.json`), formatted for readability and further processing.

---

## How to Use

1. **Run the Script**  
   Execute the script in your terminal:
   ```bash
   ./ec2_ami_info.sh
   ```

2. **View the Output**  
   The output is saved in `ami_output.json`. Open it using any text editor or JSON viewer:
   ```bash
   cat ami_output.json
   ```

3. **Optional: Change AWS Profile**  
   If you are managing multiple AWS accounts, you can specify the profile when running the script:
   ```bash
   AWS_PROFILE=my-profile ./ec2_ami_info.sh
   ```

---

## Example Output

Here is an example of the JSON file generated by the script:

```json
{
  "ami-0d5f069b7a75be450": {
    "ImageDescription": "ubuntu-1804-encrypted-amd64-20190403",
    "ImageName": "ubuntu-1804-encrypted-amd64-20190403",
    "ImageLocation": "12345678901/ubuntu-1804-encrypted-amd64-20190403",
    "OwnerId": "12345678901",
    "InstanceIds": [
      "i-04f241953cfe0066d",
      "i-02439968b22cb6b8d"
    ]
  },
  "ami-1df0ac78": {
    "ImageDescription": null,
    "ImageName": null,
    "ImageLocation": null,
    "OwnerId": null,
    "InstanceIds": [
      "i-19be2ba7",
      "i-6a7a49dd"
    ]
  }
}
```

---

## Security Considerations

- The script fetches only the necessary data to minimize API calls and reduce unnecessary exposure of account details.
- AWS credentials are securely managed using CLI profiles, avoiding the need for hard-coded credentials.
- Use IAM policies with the least privilege principle to ensure the script operates securely.

---

## Customization

- **Region**: By default, the script uses the current AWS region configured in the CLI. Modify the region by setting the `AWS_DEFAULT_REGION` environment variable:
  ```bash
  export AWS_DEFAULT_REGION=us-west-1
  ```

- **Output File**: Change the output file name by editing the `OUTPUT_FILE` variable at the top of the script.

---

## Support

If you encounter any issues or have questions about this script, please feel free to contact me or raise an issue in the repository.

---

## License

This project is licensed under the MIT License. Feel free to use, modify, and distribute it.
